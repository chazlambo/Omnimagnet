# 2D Omnimagnet Tractor Beam

This repository implements a real-time control and visualization system for a **2D Omnimagnet Tractor Beam**. It enables precise dipole field control using multiple omnimagnets, synchronized image capture with a camera, and automated generation of annotated time-lapse videos for experiment analysis.

Note: README generated by ChatGPT

---

## ğŸ§  Project Overview

The system supports:

- Real-time control of **omnimagnets** using COMEDI (via D/A channels)
- Automated camera image capture using the **Spinnaker SDK** (for FLIR cameras)
- Structured saving of images and experiment logs
- Optional video generation with raft tracking using Python tools in the `scripts/` folder

---

## ğŸ—‚ Directory Structure

```
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ main.cpp               # Main experimental loop (edit this for your setup)
â”œâ”€â”€ cameracapture.cpp/hpp # Camera control using Spinnaker
â”œâ”€â”€ omnimagnet.cpp/hpp    # Omnimagnet modeling and control logic
â”œâ”€â”€ type.cpp/hpp          # Math utilities (e.g., pseudoinverse)
â”œâ”€â”€ /scripts              # Python post-processing tools
â”‚   â”œâ”€â”€ fisheye_calibrate.py
â”‚   â””â”€â”€ generate_experiment_timelapse.py
â””â”€â”€ /output               # Generated logs and images from each experiment
```

---

## âš™ï¸ Dependencies

**System Libraries:**

- `comedi`
- `pthread`

**External SDKs:**

- [Spinnaker SDK](https://www.flir.com/products/spinnaker-sdk/) (install manually) (Must be Version 2.3.0.77)
- [OpenCV](https://opencv.org/)
- [Eigen3](https://eigen.tuxfamily.org/) (included via `/home/ashkan/eigen/source`)

Install required packages (on Ubuntu):

```bash
sudo apt install libcomedi-dev libopencv-dev
```

---

## ğŸ›  Build Instructions

1. Clone the repository:
```bash
git clone <repo-url>
cd <repo>
```

2. Compile the code:

```bash
mkdir -p build
cd build
cmake ..
make
```

> âœ… This generates the `SystemRun` executable for running your experiment.

---

## ğŸ” Example Workflow (Step-by-Step Guide)

This section walks you through running a full experiment.

---

### âœ… Step 0 (One-Time Setup)

> âœ… The camera has already been calibrated and the calibration file (`fisheye_calibration.npz`) is included in the `scripts/` folder.

You **do not need to recalibrate** unless you're using a different camera or lens.

ğŸ”§ If you do need to recalibrate:

1. Print a **9Ã—6 checkerboard** and capture multiple images of it from different angles using the same camera. (https://github.com/opencv/opencv/blob/4.x/doc/pattern.png)
2. Save those images as `.png` files in a folder named `camera_calibration_images/` in the `scripts/` directory.
3. Run the calibration script:

This will generate a new `fisheye_calibration.npz` file automatically.

---

### âš™ï¸ Step 1: Configure Your Experiment

Open `main.cpp` in any text editor and scroll to:

```cpp
// MAIN EXPERIMENTAL SETUP
```

Update the following variables:

- `experiment_name` â€” used to name the output folder under `/output/`
- `timelapse_interval_ms` â€” sets how often images are captured (e.g., `2000` = every 2 seconds)

Optional variables you can also customize:
- Dipole strength and direction
- Rotation frequency and duration
- Which omnimagnets are active
- Other omnimagnet properties

Save and close the file after editing.

---

### ğŸ— Step 2: Build the Project

From the project root:

```bash
cd build
cmake ..
make
```

> ğŸ”§ Make sure `cmake ..` runs without errors and finds your Spinnaker and Eigen libraries.

---

### ğŸš€ Step 3: Run the Experiment

Still inside the `build` directory:

```bash
./SystemRun
```

This will:
- Start the omnimagnets
- Begin capturing time-lapse images
- Log experiment settings and metadata

> ğŸ›‘ You can press **Enter** anytime to stop the experiment early.

---

### ğŸ’¾ Step 4: Review Output

After completion, your experiment data will be saved under:

```
/output/<experiment_name>/
```

Youâ€™ll find:

- `/images/` â€” raw timelapse image frames
- `<experiment_name>_image_log.csv` â€” timestamps for each captured image
- `<experiment_name>_setup_info.txt` â€” a full record of your experimental setup
- `<experiment_name>_experiment_summary.txt` â€” total duration, number of cycles, and whether it ended early

---

### ğŸ Step 5 (Optional): Generate a Video

After your experiment, you can generate a time-lapse video (with optional raft tracking) using the Python script provided in the `/scripts` folder.

---

1. Open the script:

Open `generate_experiment_timelapse.py` in **Visual Studio Code** (or your preferred code editor).

2. Edit the configuration at the top of the file:

Make sure to review and update the following key parameters:

- `EXPERIMENT_NAME` â€“ should match the name used during the experiment (e.g. `"experiment_E2"`)
- `SPEEDUP_FACTOR` â€“ controls how fast the video plays (e.g. `30` = 30Ã— real-time)
- `NUM_RAFTS` â€“ number of rafts present in your experiment
- `RAFT_RADIUS_PX` â€“ approximate size of each raft in pixels

You can also adjust other settings:
- `IMAGE_VERSION`: Choose between `raw`, `undistorted`, `cropped`, or `tracked`
- `TRAIL_DURATION_SEC`, `DRAW_RAFT_OUTLINES`, and other tracking and cropping parameters
- `DELETE_INTERMEDIATE`: Set to `False` if you want to keep all processed images

3. Save the file and run it. (Note: Make sure you run it from within the ./scripts directory)
---

ğŸ“¹ The final video will be saved to:

```
/videos/Experiment_<Series>/<Stage>/<experiment_name>_<stage>_<speedup>x.mp4
```

> ğŸ—‚ You can re-run this script anytime to regenerate videos using different settings or overlays.

---

## ğŸ“Œ Notes

- Omnimagnets are initialized and controlled based on the parameters you define in `main.cpp`.
- The system uses a background thread to capture images in real-time without blocking dipole control.
- All experiment metadata is logged automatically and reproducibly.
- You can reuse or modify the Python scripts to extract further analysis from the image data.

---